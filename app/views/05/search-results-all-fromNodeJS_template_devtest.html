{% extends "./layouts/_BASE.html" %}

{% set withDescriptionAndLink = "true" %}
{% set pageHeading = "Search results" %}
{% set pageDescription = "Use the filters to explore these nearby courses." %}

{% block content %}

<head>
  <meta charset="UTF-8">
  <title>Search Results - Department for Education</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #f8f9fa;
      color: #222;
    }


    header {
      background-color: #003865;
      color: white;
      padding: 15px 20px;
    }


    header h1 {
      margin: 0;
      font-size: 1.4em;
    }


    header p {
      margin: 5px 0 0;
    }


    .alpha-banner {
      background: #e7f1ff;
      padding: 10px 20px;
      font-size: 0.9em;
      color: #000;
    }


    .alpha-banner a {
      color: #003865;
      text-decoration: underline;
    }


    .container {
      padding: 20px;
      max-width: 1100px;
      margin: auto;
    }


    h2 {
      margin-top: 0;
    }


    .filters {
      background-color: #ffffff;
      padding: 20px;
      border: 1px solid #ddd;
      margin-bottom: 20px;
    }


    .filters form {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }


    .filters label {
      display: block;
      font-weight: bold;
      margin-bottom: 4px;
    }


    .filters .form-group {
      flex: 1 1 200px;
      min-width: 200px;
    }


    .filters input[type="text"],
    .filters select {
      width: 100%;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }


    .filters input[type="checkbox"] {
      margin-right: 6px;
    }


    .filters input[type="submit"] {
      padding: 10px 16px;
      background-color: #003865;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }


    .results {
      background-color: #fff;
      padding: 20px;
      border: 1px solid #ccc;
    }


    .results h3 {
      margin-top: 0;
      color: #003865;
    }


    .results a {
      color: #003865;
      text-decoration: underline;
    }


    .results table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }


    .results td {
      padding: 8px 5px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }


    .results td:first-child {
      font-weight: bold;
      width: 180px;
    }


    @media (max-width: 768px) {
      .filters form {
        flex-direction: column;
      }


      .filters .form-group {
        width: 100%;
      }


      .results table,
      .results td {
        font-size: 0.95em;
      }


      header h1 {
        font-size: 1.2em;
      }
    }


    @media (max-width: 480px) {
      .results td:first-child {
        width: 120px;
      }
    }
  </style>
</head>
<body class="govuk-template__body">
<script>
  function showSelectedOptions(){

      var distfilter=document.getElementById('distfilter');
      var distfilter_selectedOption=dropdown1.options[dropdown1.selectedIndex].text

      var sort_type=document.getElementById('sortfilter');
      var sort_type_selected=sorttype.options[sorttype.selectedIndex].text

      console.log("Distance_FILTER OPT "+String(distfilter_selectedOption))
      console.info("HELLO THERE RUNNING SELECTED OPTIONS")
      document.getElementById('opt1').value=distfilter_selectedOption;
      document.getElementById('opt1_attr').value=dropdown1.options[dropdown1.selectedIndex].value

      document.getElementById('sort_opt').value=sort_type_selected;

      //document.getElementById('opt1_attr').value=dropdown1.options[dropdown1.selectedIndex].value
  }
</script>

<div class="govuk-grid-row"> 

  <div class="govuk-grid-column-two-thirds">  

    
  
  <div id="CONTAINER_BLOCK">
    <div class="form-group">
      <label for="distfilter" class="govuk-label">Distance requirement:</label>
      <select id="dropdown1" name="dropdown1" class="govuk-select">
          <option value="L2">Less than 2 miles</option>
          <option value="L5">Less than 5 miles</option>
          <option value="L10">Less than 10 miles</option>
          <option value="L15">Less than 15 miles</option>
          <option value="L25">Less than 25 miles</option>
          <option value="L50">Less than 50 miles</option>
          <option value="ALL">All results</option>
      </select>
  </div>     
  <div class="form-group">
      <label for="sortfilter" class="govuk-label">Sort:</label>
      <select id="sorttype" name="sorttype" class="govuk-select">
          <option value="relevance">Relevance</option>
          <option value="Distance">Distance</option>
          <!--<option value="Diversity">Diversity</option>-->
          <option value="Rerank">Rerank</option>
      </select>
  </div>  
  <form id="jsonForm">
      <label for="userinput" class="govuk-label">Course, Opportunity or interest:</label>
      <textarea type="text" id="userinput" name="userinput" title="userinput"  class="govuk-textarea" rows="2"  ></textarea><br><br>
      <label for="location" class="govuk-label">Location:</label>
      <input type="text" id="location" name="location" title="location" class="govuk-input"><br><br>
      
      <div class="form-group">
          <label for="online_content" class="govuk-label">Include Online Content?</label><br>
          <input type="checkbox" class="govuk-checkboxes" id="online_content" title="online_content" name="online_content" value="include online">
     </div>
     
     <input type="hidden" id="opt1" name="opt1">
     <input type="hidden" id="opt1_attr" name="opt1_attr">
     <input type="hidden" id="sort_opt" name="sort_opt">
     <button type="submit" class="btn btn-primary btn-custom govuk-button" onclick=submitForm()>Search</button>
  </form>
    
      <div id ="custresponse"></div>
      <div id="outputdiv_api"><div id="HTML_CHILD">{{HTML_TABLE | safe}}</div></div>
      <script>
        function submitForm() {
            showSelectedOptions();
            const form = document.getElementById('jsonForm');
            const formData = new FormData(form);
            const jsonData = {};
    
            formData.forEach((value, key) => {
                jsonData[key] = value;
            });
            console.info("SUBMITTING HTTP REQUEST");
            event.preventDefault();
            fetch('/runVectorSearch_samepage', {            
                //mode: 'no-cors',
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                    ,'Access-Control-Allow-Origin': 'http://127.0.0.1:3001'
                    ,'Accept':'application/json'
                    ,'Access-Control-Allow-Headers': ['origin','content-type','accept']
                },
                body: JSON.stringify(jsonData)
            })
            .then(response => {
            if (!response.ok) {
                console.error('NETWORK ERROR');
                throw new Error('Network response was not ok');
            }
            console.log("RETURN");
            return response.json();
            })
            .then(data => {
              
              console.info('GETTING DATA');
              console.info(data);

              
              //console.info(response.data)
              const responseDiv = document.getElementById("custresponse");
              console.info('SETTING CUSTOM RESPONSE')
              //responseDiv.innerHTML = `<p>${JSON.stringify(data, null, 2)}</p>`
              const list_of_tables=document.getElementById('outputdiv_api');
              
              if(list_of_tables.children.length>0){
                
                  // clear previous results
                  while (list_of_tables.firstChild){
                            list_of_tables.removeChild(list_of_tables.lastChild);
                };
              }
              let payload=data['PAYLOAD']
              for (let itr=0; itr<payload.length;itr++){
                    console.log(itr)
                    var title=document.createTextNode('Course Name: '+payload[itr]['Course name']);
                    var coursetype=document.createTextNode('Course type: '+payload[itr]['Course type']);
                    var Distance=document.createTextNode('Distance: '+payload[itr]['Distance']+' miles ('+payload[itr]['Location town']+')');
                    var description=document.createTextNode('Description: '+payload[itr]['Who this course is for']);
                    var Duration=document.createTextNode('Course Duration: '+payload[itr]['Duration']);
                    var deliverymode=document.createTextNode('Delivery Mode: '+payload[itr]['Delivery mode']);
                    var Locationtown=document.createTextNode('Location: '+payload[itr]['Location']);
                    var requirements=document.createTextNode('Requirements: '+payload[itr]['Skills required']);
                    var startdate=document.createTextNode('Start Date: '+payload[itr]['Start date'])
                    let vartable=document.createElement('table');
                    vartable.classList.add('govuk-table');
                    let keys=[//'Course name',
                        'Entry requirements',
                        'Course type',
                        'Delivery mode',
                        'Level',
                        'Distance',
                        'Location town',
                        'Employer name',
                        'Provider name',
                        'Start date',
                        'Who this course is for'
                        ,'Duration'
                        ,'Score'
                    ];
                    console.log("HELLO THERE");
                    let hdr=vartable.createTHead();
                    hdr.classList.add("govuk-table__head")
                    let t1=document.createElement('th');
                    t1.textContent=payload[itr]['Course name'];
                    t1.classList.add('govuk-table__header')
                    console.log('COURSE '+payload[itr]['Course name'])
                    //console.log("GET ELEM 1");
                    let t2=document.createElement('th');
                    t2.classList.add('govuk-table__header')
                    //t2.textContent=payload[itr]['WEBSITE']  
                    //t2.textContent="TEST URL";
                    var clink=document.createElement('a');
                    clink.href=payload[itr]['Website'];
                    clink.textContent='Link to course';
                    //t2.innerHTML='<a href="'+url+'">Link to course</a>'
                    
                    t2.appendChild(clink);
                    hdr.appendChild(t1);
                    hdr.appendChild(t2);
                    for (let i =0; i<keys.length;i++){
                        let tr=vartable.insertRow();
                        tr.classList.add("govuk-table__row");
                        var name=keys[i];
                        var value=payload[itr][keys[i]];
                        let v0=tr.insertCell(0);
                        v0.classList.add("govuk-table_cell");
                        let b=document.createElement('bf');
                        //th.classList.add("govuk-table__header")
                        b.textContent=name;
                        v0.appendChild(b);
                        
                        let v1=tr.insertCell(1);
                        v1.textContent=value;
                        v1.classList.add("govuk-table_cell");
                    }
                   
                    
                    list_of_tables.appendChild(vartable);
                    list_of_tables.appendChild(document.createElement('br'));
                    
                } // end of for loop
                
            })
            .catch(error => {
            console.error('Error:', error);
            const responseDiv = document.getElementById('outputdiv_api');
            responseDiv.innerHTML = `<p style="color: red;">Custom Error: ${error.message}</p>`;
            })
        }                
      </script>
 </div>
    

{{ govukPagination({
  next: {
    href: "search-results-page-2"
  },
  items: [
    {
      number: 1,
      current: true,
      href: "#"
    },
    {
      number: 2,
      href: "search-results-page-2"
    },
    {
      number: 3,
      href: "search-results-page-3"
    }
  ]
}) }}


  </div>
</div>
</body>
{% endblock %}
